<Window x:Class="EphemeralBrowser.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:conv="clr-namespace:EphemeralBrowser.UI.Converters;assembly=EphemeralBrowser.UI"
        xmlns:vm="clr-namespace:EphemeralBrowser.UI.ViewModels;assembly=EphemeralBrowser.UI"
        xmlns:views="clr-namespace:EphemeralBrowser.UI.Views;assembly=EphemeralBrowser.UI"
        mc:Ignorable="d" 
        Title="EphemeralBrowser - Privacy First" 
        Height="900" Width="1200"
        MinHeight="600" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        d:DataContext="{d:DesignInstance Type=vm:MainViewModel}">
    
    <Window.Resources>
        <conv:CountToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Address Bar -->
            <RowDefinition Height="Auto"/> <!-- Tab Headers -->
            <RowDefinition Height="*"/>    <!-- Main Content -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>
        
        <!-- Address Bar -->
        <Border Grid.Row="0" 
                Background="#FFF8F8F8" 
                BorderBrush="#FFACACAC" 
                BorderThickness="0,0,0,1"
                Padding="8,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Navigation Buttons -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,8,0">
                    <Button Content="←" 
                            Width="32" Height="24"
                            Command="{Binding GoBackCommand}"
                            Click="BackButton_Click"
                            ToolTip="Back (Alt+Left) - Navigate to at least 2 pages to enable"/>
                    <Button Content="→" 
                            Width="32" Height="24"
                            Command="{Binding GoForwardCommand}"
                            Click="ForwardButton_Click"
                            ToolTip="Forward (Alt+Right) - Available after going back"
                            Margin="2,0,0,0"/>
                </StackPanel>
                
                <!-- Address Bar -->
                <TextBox Grid.Column="1" 
                         x:Name="AddressBar"
                         Height="24"
                         VerticalContentAlignment="Center"
                         Text="{Binding CurrentUrl, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,8,0"
                         FontFamily="Segoe UI"
                         FontSize="12">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="about:blank">
                                    <Setter Property="Foreground" Value="Gray"/>
                                </Trigger>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Foreground" Value="Gray"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding NavigateCommand}" CommandParameter="{Binding Text, RelativeSource={RelativeSource AncestorType=TextBox}}"/>
                    </TextBox.InputBindings>
                </TextBox>
                
                <!-- Action Buttons -->
                <Button Grid.Column="2" 
                        Content="⟳" 
                        Width="32" Height="24"
                        Command="{Binding RefreshCommand}"
                        ToolTip="Refresh (F5)"
                        Margin="0,0,8,0"/>
                <Button Grid.Column="3" 
                        Content="+" 
                        Width="32" Height="24" 
                        Command="{Binding NewTabCommand}"
                        ToolTip="New Container (Ctrl+T)"
                        Margin="0,0,8,0"/>
                

            </Grid>
        </Border>
        
        <!-- Tab Headers -->
        <Border Grid.Row="1" 
                Background="#FFF0F0F0" 
                BorderBrush="#FFACACAC" 
                BorderThickness="0,0,0,1"
                Padding="4">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Hidden">
                <ItemsControl ItemsSource="{Binding Tabs}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="White"
                                    BorderBrush="#FFACACAC"
                                    BorderThickness="1,1,1,0"
                                    CornerRadius="4,4,0,0"
                                    Margin="2,0,0,0"
                                    MinWidth="150"
                                    MaxWidth="250">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Button Grid.Column="0"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Padding="8,4"
                                            HorizontalContentAlignment="Left"
                                            Command="{Binding DataContext.SelectTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Title}" 
                                                      FontWeight="SemiBold"
                                                      FontSize="11"
                                                      TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding ProfileId, StringFormat='ID: {0}'}" 
                                                      FontSize="9"
                                                      Foreground="#FF666666"
                                                      FontFamily="Consolas"
                                                      TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>
                                    </Button>
                                    
                                    <Button Grid.Column="1"
                                            Content="×"
                                            Width="20" Height="20"
                                            Margin="0,2,4,2"
                                            FontSize="14"
                                            FontWeight="Bold"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Close Tab"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>
        
        <!-- Main Content - All Tabs with Visibility Switching -->
        <Grid Grid.Row="2">
            <ItemsControl ItemsSource="{Binding Tabs}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Grid/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:TabViewModel}">
                        <views:TabView Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
        
        <!-- Status Bar -->
        <Border Grid.Row="3" 
                Background="#FFF8F8F8" 
                BorderBrush="#FFACACAC" 
                BorderThickness="0,1,0,0"
                Padding="8,4">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                <TextBlock Text=" | " Margin="8,0" VerticalAlignment="Center" Foreground="#FF666666"/>
                <TextBlock Text="{Binding Tabs.Count, StringFormat='Containers: {0}'}" VerticalAlignment="Center" Foreground="#FF666666"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
